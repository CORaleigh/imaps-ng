"use strict";angular.module("imapsNgApp",["ngTouch","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","pageslide-directive","ui.bootstrap","vr.directives.slider","LocalStorageModule","angular-loading-bar","cfp.loadingBar","ngCsv","ngReactGrid"]),angular.module("imapsNgApp").controller("MainCtrl",["$rootScope","config",function(a,b){a.checked=!0,b.loadConfig("../config/config.txt").then(function(b){a.config=b})}]),angular.module("imapsNgApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("imapsNgApp").directive("appHeader",function(){return{templateUrl:"appHeader/appHeader.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.checked=!0,b.$watch("config",function(b){b&&(a.title=b.title)}),a.btnClick=function(){b.checked=!b.checked},a.titleClick=function(){console.log(this.$root.config),this.title=this.$root.config.title}}]}}),angular.module("imapsNgApp").directive("exportButton",function(){return{templateUrl:"exportButton/exportButton.html",restrict:"E",scope:{array:"=",filename:"@"},link:function(){}}}),angular.module("imapsNgApp").directive("mapPanel",["cfpLoadingBar",function(a){return{templateUrl:"mapPanel/mapPanel.html",restrict:"E",controller:["$scope","$rootScope","property",function(b,c,d){b.property=d;var e=function(){a.start()},f=function(){a.complete()};require(["esri/map","esri/arcgis/utils","esri/SpatialReference","esri/layers/GraphicsLayer","dojo/on","dojo/domReady!"],function(a,c,d,g,h){c.createMap("0757b2fd0e6f44dd8d8fefbfc09aa8eb","map").then(function(a){b.webmap=a,b.map=a.map,b.selectionMultiple=new g,b.selectionSingle=new g,b.map.addLayer(b.selectionMultiple),b.map.addLayer(b.selectionSingle),console.log(a),b.$digest(),h(b.map,"update-start",e),h(b.map,"update-end",f)})});var g=function(a,c,d){require(["esri/graphic","esri/graphicsUtils"],function(e,f){var g=null;c.clear(),b.selectionSingle.clear(),angular.forEach(a,function(a){g=new e({geometry:a.geometry,symbol:{color:[0,0,0,0],outline:{color:d,width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"}}),b.geometry=g.geometry,c.add(g)}),b.map.setExtent(f.graphicsExtent(c.graphics),!0)})};b.$on("accountUpdate",function(a,c){var d=[];c&&(angular.forEach(c,function(a){d.push("'"+a.pin+"'")}),b.property.getGeometryByPins("PIN_NUM in ("+d.toString()+")").then(function(a){g(a.features,b.selectionMultiple,[255,255,0])}))}),b.$on("pinUpdate",function(a,c){b.property.getGeometryByPins("PIN_NUM = '"+c+"'").then(function(a){g(a.features,b.selectionSingle,[255,0,0])})})}],link:function(){}}}]),angular.module("imapsNgApp").directive("sidePanel",["$timeout",function(){return{templateUrl:"sidePanel/sidePanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){a.checked=!0,b.$watch("checked",function(b){a.checked=b})}],link:function(){}}}]),angular.module("imapsNgApp").directive("toolPanel",["$timeout",function(){return{templateUrl:"toolPanel/toolPanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.toolsChecked=!1,b.$watch("toolsChecked",function(b){a.toolsChecked=b}),a.toolHeaderClick=function(a){b.toolsChecked=!a}}],link:function(){}}}]),angular.module("imapsNgApp").directive("baseMapPanel",["$timeout",function(){return{templateUrl:"baseMapPanel/baseMapPanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.mapsChecked=!1,b.$watch("mapsChecked",function(b){a.mapsChecked=b}),a.mapsHeaderClick=function(a){b.mapsChecked=!a}}],link:function(){}}}]),angular.module("imapsNgApp").directive("overviewPanel",["$timeout",function(){return{templateUrl:"overviewPanel/overviewPanel.html",restrict:"E",controller:["$scope","$rootScope",function(a,b){b.overviewChecked=!1,b.$watch("overviewChecked",function(b){a.overviewChecked=b}),a.overviewHeaderClick=function(a){b.overviewChecked=!a},a.$watch("map",function(a){a&&require(["esri/dijit/OverviewMap"],function(b){var c=new b({map:a,visible:!0,width:"100%"},"overview");c.startup()})})}],link:function(){}}}]),angular.module("imapsNgApp").directive("search",function(){return{templateUrl:"sidePanel/search/search.html",restrict:"E",controller:["$scope",function(){}],link:function(a){a.searches=[{label:"For Property",value:"property"},{label:"For Location",value:"location"}],a.selectedSearch=a.searches[0]}}}),angular.module("imapsNgApp").directive("propertySearch",function(){return{templateUrl:"sidePanel/propertySearch/propertySearch.html",restrict:"E",controller:["$scope","$rootScope","$timeout","property",function(a,b,c,d){a.hiddenOverflow=!1,a.property=d;var e="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/AutoComplete",f=function(a){var b=[];return a.Results.length>0&&angular.forEach(a.Results,function(a){b.push({value:a})}),b};a.tabChanged=function(b){angular.forEach(a.tabs,function(a,c){c>0&&(a.disabled=b),a.highlighted=!1}),a.tab.highlighted=!0},a.$on("accountSelected",function(){a.tabChanged(!1)});var g=function(d,e,f){f="streetname"===f?"street name":f,a.property.getRealEstate(f,[e.value]).then(function(d){a.fields=d.Fields,console.log(d.Accounts.length),a.accounts=d.Accounts,a.accountsSrc=d.Accounts,b.$broadcast("accountUpdate",a.accounts),1===d.Accounts.length?(a.tab=a.tabs[1],a.pin=d.Accounts[0].pin,a.reid=d.Accounts[0].reid,a.account=d.Accounts[0],b.$broadcast("pinUpdate",a.pin),c(function(){a.$broadcast("accountSelected",d.Accounts[0])})):(a.tab=a.tabs[0],a.tabChanged(!0))})},h=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:e+"?type=address&f=json",filter:f,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),i=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:e+"?type=owner&f=json",filter:f,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),j=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:e+"?type=pin&f=json&limit=5",filter:f,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),k=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:e+"?type=reid&f=json&limit=5",filter:f,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}}),l=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.value)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:e+"?type=street name&f=json&limit=5",filter:f,replace:function(a,b){b=b.replace(/\'/g,"''").toUpperCase();var c=a+"&input="+b;return c}}});h.initialize(),i.initialize(),j.initialize(),k.initialize(),l.initialize(),a.autocomplete={displayKey:"value",source:h.ttAdapter()},a.searchValue=null,$("#searchInput").typeahead({hint:!0,highlight:!0,minLength:1},{name:"address",displayKey:"value",source:h.ttAdapter(),templates:{header:"<h5>Addresses</h5>"}},{name:"owner",displayKey:"value",source:i.ttAdapter(),templates:{header:"<h5>Owners</h5>"}},{name:"pin",displayKey:"value",source:j.ttAdapter(),templates:{header:"<h5>PIN</h5>"}},{name:"reid",displayKey:"value",source:k.ttAdapter(),templates:{header:"<h5>Real Estate ID</h5>"}},{name:"streetname",displayKey:"value",source:l.ttAdapter(),templates:{header:"<h5>Street</h5>"}}).on("typeahead:selected",g);var m=function(b){angular.forEach(a.tabs,function(a){a.highlighted=!1}),b.highlighted=!0},n=function(b){switch(b.title){case"Results":break;case"Info":break;case"Photos":a.property.getPhotos(a.account.reid).then(function(b){a.photos=b.Photos});break;case"Deeds":a.property.getDeeds(a.account.reid).then(function(b){a.deeds=b.Deeds,a.plats=[],angular.forEach(a.deeds,function(b){b.bomDocNum&&a.plats.push(b)})});break;case"Tax Info":window.open("http://services.wakegov.com/realestate/Account.asp?id="+a.account.reid,"_blank");break;case"Services":a.$broadcast("servicesClicked",a.geometry);break;case"Addresses":a.property.getAddresses(a.account.pin,a.account.reid).then(function(b){a.addresses=b.Addresses})}};a.tabClicked=function(b){b.disabled||(a.tab=b,m(b),n(b))}}],link:function(a){a.tabs=[{icon:"list",title:"Results",highlighted:!0,disabled:!1,table:!0},{icon:"info-sign",title:"Info",highlighted:!1,disabled:!0,table:!0},{icon:"picture",title:"Photos",highlighted:!1,disabled:!0,table:!1},{icon:"file",title:"Deeds",highlighted:!1,disabled:!0,table:!1},{icon:"usd",title:"Tax Info",highlighted:!1,disabled:!0,table:!1},{icon:"flag",title:"Services",highlighted:!1,disabled:!0,table:!1},{icon:"home",title:"Addresses",highlighted:!1,disabled:!0,table:!0}],a.tab=a.tabs[0]}}}),angular.module("imapsNgApp").directive("propertyResults",function(){return{templateUrl:"sidePanel/propertySearch/propertyResults/propertyResults.html",restrict:"E",controller:["$scope","$timeout","$window",function(a,b,c){a.accounts=[],a.$watch("accounts",function(b){a.resultGrid.data=b}),a.resultGrid={data:a.accounts,showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height()-70,columnDefs:[{field:"siteAddress",displayName:"Address"},{field:"owner",displayName:"Owner"},{field:"pin",displayName:"PIN"}],rowClick:function(b){a.resultClicked(b)}},a.$watch("accounts",function(){}),a.resultClicked=function(b){a.account=b,a.tab=a.tabs[1],a.$broadcast("accountSelected",b)};var d=angular.element(c);a.getWindowDimensions=function(){return{h:d.height(),w:d.width()}},a.$watch(a.getWindowDimensions,function(){$(".ngReactGridViewPort").css("max-height",$(".tabcontainer").height()-70),$(".ngReactGridViewPort").css("min-height",$(".tabcontainer").height()-70)},!0),d.bind("resize",function(){a.$apply()})}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyInfo",function(){return{templateUrl:"sidePanel/propertySearch/propertyInfo/propertyInfo.html",restrict:"E",controller:["$scope","$filter","$timeout","$rootScope",function(a,b,c,d){a.accountInfo=[];var e=function(e){a.accountInfo=[],a.tabChanged(!1),a.pin=e.pin,a.reid=e.reid,d.$broadcast("pinUpdate",e.pin),angular.forEach(a.fields,function(c){"currency"===c.type&&(e[c.field]=b("currency")(e[c.field],"$",0)),a.accountInfo.push({field:c.alias,value:e[c.field]})}),c(function(){a.infoGrid.data=a.accountInfo})};a.account&&!a.accountInfo&&e(a.account),a.$on("accountSelected",function(a,b){e(b)}),a.infoGrid={data:a.accountInfo,showGridShowPerPage:!1,showGridSearch:!1,pageSize:100,pageSizes:[100],height:$(".tabcontainer").height()-70,columnDefs:[{field:"field",displayName:"Field",sort:!1},{field:"value",displayName:"Value",sort:!1}]},a.toggleProperty=function(b){var c=a.accounts.indexOf(a.account),d=b?c+1:c-1;-1===d?d=a.accounts.length-1:d===a.accounts.length&&(d=0),a.account=a.accounts[d],a.$broadcast("accountSelected",a.account)}}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyPhotos",function(){return{templateUrl:"sidePanel/propertySearch/propertyPhotos/propertyPhotos.html",restrict:"E",controller:["$scope",function(){}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyDeeds",function(){return{templateUrl:"sidePanel/propertySearch/propertyDeeds/propertyDeeds.html",restrict:"E",controller:["$scope",function(){}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyTaxes",function(){return{templateUrl:"sidePanel/propertySearch/propertyTaxes/propertyTaxes.html",restrict:"E",controller:["$scope",function(){}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyServices",function(){return{templateUrl:"sidePanel/propertySearch/propertyServices/propertyServices.html",restrict:"E",controller:["$scope",function(a){a.$on("servicesClicked",function(){require(["esri/graphic"],function(b){var c=new esriConverter,d={type:"Feature",geometry:c.toGeoJson(a.geometry)},e=turf.buffer(d,-5,"feet");c=new geoJsonConverter;var f=c.toEsri(e);console.log(f),f.features[0].symbol={color:[0,0,0,64],outline:{color:[0,0,0,255],width:1,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"};var g=new b(f.features[0]);a.map.graphics.add(g)})})}],link:function(){}}}),angular.module("imapsNgApp").directive("propertyAddresses",function(){return{templateUrl:"sidePanel/propertySearch/propertyAddresses/propertyAddresses.html",restrict:"E",controller:["$scope",function(a){a.rpid=null,a.raleighCols=[{field:"address",displayName:"Address"},{field:"type",displayName:"Type"},{field:"status",displayName:"Status"}],a.wakeCols=[{field:"address",displayName:"Address"}],a.addrGrid={data:[],showGridShowPerPage:!1,showGridSearch:!1,pageSize:1e4,pageSizes:[1e4],height:$(".tabcontainer").height()-70,columnDefs:a.raleighCols},a.$watch("addresses",function(b){b&&b.length>0&&(a.addrGrid.data=b,b[0].rpidMap?(a.addrGrid.columnDefs=a.raleighCols,a.rpid=b[0].rpidMap+" "+b[0].rpidLot,angular.forEach(b,function(a){a.suite.trim().length>0&&(a.address+=", STE "+a.suite)})):(a.addrGrid.columnDefs=a.wakeCols,a.rpid=null))})}],link:function(){}}}),angular.module("imapsNgApp").directive("locationSearch",function(){return{templateUrl:"sidePanel/locationSearch/locationSearch.html",restrict:"E",controller:["$scope",function(){}],link:function(){}}}),angular.module("imapsNgApp").directive("layerList",["$timeout","$window","$filter","legend","localStorageService",function(a,b,c,d){return{templateUrl:"sidePanel/layerList/layerList.html",restrict:"E",controller:["$scope",function(a){a.$watch("map",function(b){b&&(b.on("load",function(){}),a.layers=a.webmap.itemInfo.itemData.operationalLayers,angular.forEach(a.layers,function(b){d.getLegend(b.url,b.id).then(function(b){var d=c("filter")(a.layers,function(a){return a.id===b.id})[0];angular.forEach(d.resourceInfo.layers,function(a,c){b.layers[c]&&(a.legend=b.layers[c].legend)})})}))}),a.layerToggle=function(b){b.visibility=!b.visibility,a.map.getLayer(b.id).setVisibility(b.visibility)},a.subLayerToggle=function(b,c){var d=[];c.defaultVisibility=!c.defaultVisibility,d=a.map.getLayer(b.id).visibleLayers,c.defaultVisibility?d.push(c.id):d.splice(d.indexOf(c.id),1),0===d.length&&(d=[-1]),a.map.getLayer(b.id).setVisibleLayers(d)},a.opacityChanged=function(b){a.map.getLayer(b.id).setOpacity(b.opacity)}}],link:function(c,d){var e=function(){{var a=document.getElementsByClassName("panel-heading");document.getElementsByClassName("panel-body")}if(a.length>0){var e=b.innerHeight;e-=a.length*a[0].offsetHeight,c.accordionHeight={height:e-d.parent().parent().parent().position().top-30+"px",overflow:"none"}}};a(e.bind(d),0);var f=angular.element(b);c.getWindowDimensions=function(){return{h:f.height(),w:f.width()}},c.$watch(c.getWindowDimensions,function(){e()},!0),f.bind("resize",function(){c.$apply()})}}}]).factory("legend",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"GET",url:c+"/legend",params:{f:"json"}}).success(function(a){a.id=d,e.resolve(a)}),e.promise}var d={getLegend:c};return d}]),angular.module("imapsNgApp").factory("config",["$http","$q",function(a,b){function c(c){var d=b.defer();return a({method:"GET",url:c}).success(d.resolve),d.promise}var d={loadConfig:c};return d}]),angular.module("imapsNgApp").factory("property",["$http","$q",function(a,b){function c(c,d){var e=b.defer();return a({method:"GET",url:i+"RealEstateSearch",params:{type:c,values:JSON.stringify(d),f:"json"}}).success(e.resolve),e.promise}function d(c){var d=b.defer();return a({method:"GET",url:i+"PhotoSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function e(c){var d=b.defer();return a({method:"GET",url:i+"DeedSearch",params:{reid:c,f:"json"}}).success(d.resolve),d.promise}function f(c,d){var e=b.defer();return a({method:"GET",url:i+"AddressSearch",params:{pin:c,reid:d,f:"json"}}).success(e.resolve),e.promise}function g(c){var d=b.defer();return a({method:"POST",url:j+"/0/query",params:{where:c,returnGeometry:!0,outSR:4326,f:"pjson"}}).success(d.resolve),d.promise}var h={getRealEstate:c,getPhotos:d,getDeeds:e,getAddresses:f,getGeometryByPins:g},i="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/exts/PropertySOE/",j="https://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer";return h}]);